# Voting Gates Configuration
# Defines quality gates with voter assignments and thresholds

gates:
  # ============================================
  # MAJOR GATES (5 Voters, 3+ to pass)
  # ============================================
  
  - id: requirements_approval
    name: "Requirements Approval"
    type: major
    trigger: "BA completes user stories"
    threshold: 3
    max_retries: 3
    voters:
      - voter_completeness
      - voter_clarity
      - voter_testability
      - voter_feasibility
      - voter_user_value
    on_pass: "proceed_to_architecture"
    on_fail: "return_to_business_analyst"
    feedback_required: true

  - id: architecture_approval
    name: "Architecture Approval"
    type: major
    trigger: "Architect completes design"
    threshold: 3
    max_retries: 3
    voters:
      - voter_scalability
      - voter_security
      - voter_maintainability
      - voter_performance
      - voter_integration
    on_pass: "proceed_to_development"
    on_fail: "return_to_solutions_architect"
    feedback_required: true

  - id: release_readiness
    name: "Release Readiness"
    type: major
    trigger: "All code complete, tests passing"
    threshold: 3
    max_retries: 3
    voters:
      - voter_code_quality
      - voter_test_coverage
      - voter_security
      - voter_documentation
      - voter_operations
    on_pass: "proceed_to_deployment"
    on_fail: "return_to_relevant_agent"
    feedback_required: true

  - id: assessment_approval
    name: "Codebase Assessment Approval"
    type: major
    trigger: "Assessment agent completes codebase analysis"
    threshold: 3
    max_retries: 3
    voters:
      - voter_completeness
      - voter_clarity
      - voter_feasibility
      - voter_security
      - voter_code_quality
    on_pass: "proceed_to_planning"
    on_fail: "return_to_assessment"
    feedback_required: true
    review_guidance: |
      IMPORTANT: You are evaluating WHETHER THE ASSESSMENT WAS DONE PROPERLY,
      NOT whether the codebase being assessed is good or bad.

      Ask yourself:
      - Is the assessment thorough and complete? (Did it cover all areas?)
      - Are the findings clearly documented with specific examples?
      - Are the scores justified with evidence?
      - Is the methodology sound?
      - Are the recommendations actionable?

      DO NOT reject because:
      - The codebase has low scores (that's what the assessment found)
      - The codebase has security issues (that's what the assessment reported)
      - The codebase has tech debt (that's what the assessment identified)

      APPROVE if the assessment work itself is thorough, clear, and well-documented.
      REJECT only if the assessment is incomplete, unclear, or methodologically flawed.

  - id: planning_approval
    name: "Improvement Planning Approval"
    type: major
    trigger: "Planning agent completes improvement plan"
    threshold: 3
    max_retries: 3
    voters:
      - voter_feasibility
      - voter_user_value
      - voter_maintainability
      - voter_scalability
      - voter_integration
    on_pass: "proceed_to_execution"
    on_fail: "return_to_planning"
    feedback_required: true
    review_guidance: |
      IMPORTANT: You are evaluating WHETHER THE IMPROVEMENT PLAN IS WELL-CONSTRUCTED,
      NOT whether the current codebase is good or bad.

      Ask yourself:
      - Does the plan address the findings from the assessment?
      - Are tasks properly prioritized and sequenced?
      - Are effort estimates reasonable?
      - Is the plan actionable with clear steps?
      - Does the plan consider dependencies between tasks?

      DO NOT reject because:
      - Some improvements will be difficult (that's expected)
      - The codebase needs a lot of work (that's why we're planning)

      APPROVE if the plan is logical, actionable, and properly structured.
      REJECT only if the plan is incomplete, poorly organized, or unrealistic.

  # ============================================
  # MINOR GATES (3 Voters, 2+ to pass)
  # ============================================

  - id: step_validation
    name: "Step Validation"
    type: minor
    trigger: "After each workflow step completes"
    threshold: 2
    max_retries: 3
    voters:
      - voter_completeness
      - voter_clarity
      - voter_feasibility
    on_pass: "continue_to_next_step"
    on_fail: "retry_step"
    feedback_required: true
    review_guidance: |
      IMPORTANT: You are evaluating WHETHER THE ASSESSMENT/ANALYSIS WAS DONE PROPERLY,
      NOT whether the codebase being assessed is good or bad.

      Ask yourself:
      - Did the assessor examine the actual code and provide specific findings?
      - Are findings backed by evidence (file paths, line numbers, code snippets)?
      - Is the scoring reasonable and explained?
      - Are recommendations actionable?

      DO NOT reject because:
      - The codebase has problems (that's what the assessment found)
      - Not every possible edge case is covered (focus on major issues)
      - The score is low (that may accurately reflect the codebase)

      APPROVE if the assessment work is thorough, specific, and evidence-based.
      REJECT only if the assessment is clearly incomplete, vague, or lacks evidence.

  - id: code_review
    name: "Code Review"
    type: minor
    trigger: "Developer completes feature code"
    threshold: 2
    max_retries: 3
    voters:
      - voter_standards
      - voter_logic
      - voter_security
    on_pass: "proceed_to_code_simplifier"
    on_fail: "return_to_developer"
    feedback_required: true

  - id: test_coverage
    name: "Test Coverage"
    type: minor
    trigger: "Test Writer completes scripts"
    threshold: 2
    max_retries: 3
    voters:
      - voter_completeness
      - voter_testability
      - voter_maintainability
    on_pass: "run_tests"
    on_fail: "return_to_test_writer"
    feedback_required: true

  # ============================================
  # SINGLE APPROVAL GATES
  # ============================================

  - id: ui_design_approval
    name: "UI/UX Design Approval"
    type: single
    trigger: "UI/UX Designer completes design"
    approver: product_owner
    criteria: "Design meets requirements and user needs"
    on_pass: "proceed_to_development"
    on_fail: "return_to_ui_ux_designer"

  - id: schema_approval
    name: "Database Schema Approval"
    type: single
    trigger: "Data Architect completes schema"
    approver: solutions_architect
    criteria: "Schema aligns with architecture"
    on_pass: "proceed_to_development"
    on_fail: "return_to_data_architect"

  - id: api_contract_approval
    name: "API Contract Approval"
    type: single
    trigger: "API Designer completes specs"
    approver: solutions_architect
    criteria: "API follows standards and architecture"
    on_pass: "proceed_to_development"
    on_fail: "return_to_api_designer"

  - id: documentation_approval
    name: "Documentation Approval"
    type: single
    trigger: "Technical Writer completes docs"
    approver: code_reviewer
    criteria: "Documentation is complete and accurate"
    on_pass: "mark_complete"
    on_fail: "return_to_technical_writer"

  - id: deployment_config_approval
    name: "Deployment Config Approval"
    type: single
    trigger: "DevOps completes deployment config"
    approver: security_specialist
    criteria: "No exposed secrets, secure configuration"
    on_pass: "ready_for_deploy"
    on_fail: "return_to_devops"

# ============================================
# FAILURE HANDLING
# ============================================
failure_handling:
  max_global_retries: 3
  
  escalation:
    trigger: "3 consecutive gate failures"
    action: "flag_for_human_review"
    include:
      - all_voter_feedback
      - artifact_history
      - decision_log
  
  circuit_breaker:
    trigger: "same_feature_fails_3_gates"
    action: "immediate_escalation"
    reason: "Likely requirements/architecture mismatch"

# ============================================
# VOTE RESPONSE FORMAT
# ============================================
vote_format:
  required_fields:
    - vote: "pass | fail"
    - confidence: "1-100 (how confident in the pass/fail decision)"
    - reasoning: "Brief explanation"
    - concerns: "List of specific concerns (if fail)"
    - suggestions: "Improvement suggestions (if fail)"
